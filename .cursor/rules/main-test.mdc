---
alwaysApply: true
---

# Responsive Layout Checker Rules

## Purpose
このプロジェクトは、複数の画面幅でWebページのレイアウト崩れを自動検出するツールです。
Cursorエージェント自身が画像を分析する方式を採用しています。

## ユーザーコマンド

### "チェックして" または "check" コマンド
ユーザーがこのコマンドを実行した場合、以下の手順を実行：

1. urls.txtファイルが存在することを確認
2. 必要なパッケージがインストールされているか確認（なければ `npm install` を実行）
   - **重要**: `required_permissions: ['all']` を指定すること
3. Playwrightブラウザがインストールされているか確認（なければ `npx playwright install chromium` を実行）
   - **重要**: `required_permissions: ['all']` を指定すること
   - **注意**: `--yes` フラグは存在しないため使用しない
4. TypeScriptをビルド（`npm run build`）
5. スクリーンショット撮影を実行（`npm start`）
   - **重要**: `required_permissions: ['all']` を指定すること
   - タイムアウトするURLがあっても処理を続行
6. `analysis-tasks.json`が生成されたことを確認
7. 画像分析を自動的に開始（下記の「画像分析手順」を実行）
8. 分析完了後、レポート生成（`npm run report`）
9. レポートが自動的にブラウザで開く

### "画像を分析して" または "analyze" コマンド
ユーザーがこのコマンドを実行した場合、以下の手順を実行：

1. `analysis-tasks.json`を読み込む
2. 各タスクについて：
   - 基準画像（1400px、375px）を読み込む
   - チェック対象画像を読み込む
   - 3つの画像を比較分析
   - レイアウトの問題を検出
3. 分析結果を`analysis-results.json`に保存
4. レポートを生成（`npm run report`）

## プロジェクト構造

- `urls.txt`: チェック対象のURLリスト（改行区切り）
- `src/`: TypeScriptソースコード
  - `capture.ts`: Playwrightでスクリーンショット撮影
  - `analyze.ts`: 分析タスク・結果の管理
  - `report.ts`: HTMLレポート生成
  - `main.ts`: メインエントリーポイント
- `screenshots/`: 撮影したスクリーンショットの保存先
- `analysis-tasks.json`: 分析タスクリスト（自動生成）
- `analysis-results.json`: 分析結果（Cursorエージェントが生成）
- `reports/`: 生成されたHTMLレポートの保存先

## 画面幅
1920, 1600, 1400, 1200, 1000, 950, 800, 600, 400, 375px

## 基準画面
- 1400px（デスクトップ基準）
- 375px（モバイル基準）

これらの画面は正しく表示されている前提で、他の画面幅との比較を行う。

## 画像分析手順（Cursorエージェントが実行）

1. **全タスクの詳細分析**
   - 全てのURLと画面幅の組み合わせを詳細に分析
   - 各ページには固有のレイアウトや機能があるため、サンプリングでは問題を見逃す可能性がある
   - ページごとに基準画像（1400px、375px）と比較して問題を検出
   
2. **分析の実行**
   - 各タスクについて、基準画像（1400px、375px）を読み込む
   - チェック対象画像を読み込む
   - 3つの画像を比較分析し、レイアウトの問題を検出
   
3. **結果の生成**
   - 全URLに対して`analysis-results.json`を生成
   - 問題がないページは`issues: []`とする
   - 問題があるページは詳細な問題情報を記録

### チェック観点

各タスクについて、以下の観点でレイアウトの問題を検出：
- テキストの重なり、はみ出し、切れ
- 画像の変形、切れ、アスペクト比の異常
- ナビゲーションメニューの崩れ、重なり
- ボタンやリンクの配置異常、クリック不可能な状態
- コンテンツの隠れ、消失
- 著しい余白の異常

【重要】明らかに問題がある場合のみ報告する。微細な違いや許容範囲の変化は無視する。

分析結果のフォーマット（`analysis-results.json`）:
```json
[
  {
    "url": "https://example.com",
    "slug": "example-com",
    "issues": [
      {
        "url": "https://example.com",
        "slug": "example-com",
        "width": 1600,
        "severity": "major",
        "description": "ナビゲーションメニューが2行に折り返され、重なっている",
        "screenshotPath": "screenshots/example-com/1600px.png",
        "baselineComparison": {
          "desktop": "screenshots/example-com/1400px.png",
          "mobile": "screenshots/example-com/375px.png"
        }
      }
    ],
    "analyzedAt": "2024-01-01T00:00:00.000Z"
  }
]
```

severity レベル:
- `critical`: ページが使用不可能なレベルの問題
- `major`: 重要な機能が使えない、または大きくデザインが崩れている
- `minor`: 軽微な表示の乱れ

## トラブルシューティング

### よくある問題と解決方法

1. **npm installでEPERMエラー**
   - 原因: サンドボックス制限
   - 解決: `required_permissions: ['all']` を指定

2. **Playwright installで`unknown option '--yes'`エラー**
   - 原因: `--yes` フラグは存在しない
   - 解決: フラグなしで `npx playwright install chromium` を実行

3. **スクリーンショット撮影でタイムアウト**
   - 原因: ページの読み込みが遅い、またはページが存在しない
   - 対処: エラーは記録されるが、処理は続行される

4. **大量のタスクで画像分析が遅い**
   - 原因: 全画像を個別に読み込むと時間がかかる
   - 対処: 全タスクの分析が必要だが、時間がかかることを理解した上で実行
   - 注意: サンプリング方式は問題の見逃しにつながるため採用しない